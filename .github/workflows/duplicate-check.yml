name: Check for Duplicate Issues

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  check-duplicates:
    runs-on: ubuntu-latest
    steps:
      - name: Check for duplicates with LLM
        uses: actions/github-script@v6
        env:
          MODELS_PAT: ${{ secrets.MODELS_PAT }}
        with:
          script: |
            const issue = context.payload.issue;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            // Prepare prompt for LLM - include all issues (open and closed)
            const allIssuesText = issues.filter(i => i.number !== issue.number).map(i => `Issue #${i.number} [${i.state}]: ${i.title} - ${i.body?.substring(0,200) || 'No description'}`).join('\n\n');
            const prompt = `You are a duplicate issue detector. Compare the new issue below with all existing issues.\n\nNew issue:\nTitle: ${issue.title}\nBody: ${issue.body || 'No description'}\n\nExisting issues:\n${allIssuesText}\n\nTask: Is this new issue a duplicate or near-duplicate of any existing issue (open or closed)?\nIf YES: Reply ONLY with the issue number in format "#123"\nIf NO: Reply ONLY with "No duplicate"\n\nYour answer:`;
            
            // Call GitHub Models API (GPT-4o-mini)
            const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.MODELS_PAT}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 100
              })
            });
            
            if (!response.ok) {
              const errorText = await response.text();
              console.log('LLM call failed:', response.status, errorText);
              return;
            }
            
            const result = await response.json();
            console.log('LLM Response:', JSON.stringify(result, null, 2));
            const llmResponse = result.choices[0].message.content.trim();
            console.log('LLM Answer:', llmResponse);
            
            // Check if LLM found a duplicate (extract issue number)
            const match = llmResponse.match(/#(\d+)/);
            if (match) {
              const dupNumber = match[1];
              console.log('Duplicate detected:', dupNumber);
              // Close the issue, add label, comment
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                labels: ['duplicate']
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This issue has been closed as a duplicate of #${dupNumber}.`
              });
            } else {
              console.log('No duplicate found');
            }